---
  machine:
    node:
      version: 0.10.33
    services:
      - docker
    environment:
      PATH: ${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin

  checkout:
    post:
      - >
        docker login \
          -e ${TUTUM_EMAIL} \
          -u ${TUTUM_USER} \
          -p ${TUTUM_PASSWORD} \
          tutum.co

  dependencies:
    override:
      - npm install
      - bower install

  test:
    pre:
      - gulp build
      - docker build -t welcome .
      - webdriver-manager update
      - webdriver-manager start:
          background: true
      - docker run --name db -d dockerslim/mongo:mongod --smallfiles
      - ip=$(docker inspect -f '{{.NetworkSettings.IPAddress}}' db)
      - docker run --name app --env MONGO_URL=mongodb://$ip:27017/test -p 80:8080 -d welcome
    override:
      - protractor protractor.config.js

  deployment:
    production:
      branch: master
      commands:
        - docker tag welcome tutum.co/$TUTUM_USER/$CIRCLE_PROJECT_REPONAME
        - docker push tutum.co/$TUTUM_USER/$CIRCLE_PROJECT_REPONAME
