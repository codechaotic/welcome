---
  machine:
    node:
      version: 0.10.33
    services:
      - mongodb
      - docker
    environment:
      IMAGE: $TUTUM_USER/$CIRCLE_PROJECT_REPONAME
      PATH: ${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin

  dependencies:
    override:
      - npm install
      - bower install

  test:
    pre:
      - gulp build
      - docker build -t $IMAGE .
      - webdriver-manager update
      - webdriver-manager start:
          background: true
      - docker run -dit -p 80:8080 $IMAGE
    override:
      - protractor protractor.config.js

  deployment:
    production:
      branch: master
      commands:
        - >
          docker login \
            -e $TUTUM_EMAIL \
            -u $TUTUM_USER \
            -p $TUTUM_PASSWORD \
            tutum.co
        - docker tag $IMAGE tutum.co/$IMAGE
        - docker push tutum.co/$IMAGE
